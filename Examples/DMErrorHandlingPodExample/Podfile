
platform :ios, '17.0'

## Define the dependency manager based on the environment variable
#dependency_manager = ENV['DEPENDENCY_MANAGER'] || 'POD' # Default to POD if not specified
#
#target 'DMErrorHandlingPodExample' do
#  # Conditionally include the DMErrorHandling pod for CocoaPods
#  if dependency_manager == 'POD'
#    pod 'DMErrorHandling', path: '../../'
#    
#    post_install do |installer|
#      puts "Using CocoaPods as the dependency manager..."
#      
#      # Remove the SPM package reference from the project file
#      remove_spm_dependency(installer)
#      
#      # Apply xcconfig files
#      apply_xcconfig_files(installer)
#    end
#  else
#    puts "Using Swift Package Manager as the dependency manager..."
#    
#    # Add the SPM package reference to the project file
#    add_spm_dependency(installer)
#    
#    # Apply xcconfig files
#    apply_xcconfig_files(installer)
#  end
#end
#
## Helper method to apply xcconfig files
#def apply_xcconfig_files(installer)
#  config_base_path = File.expand_path('DMErrorHandlingPodExample/Configuration', __dir__)
#  
#  installer.pods_project.targets.each do |target|
#    target.build_configurations.each do |config|
#      case config.name
#      when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
#        xcconfig_path = File.join(config_base_path, 'Debug-POD.xcconfig')
#      when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
#        xcconfig_path = File.join(config_base_path, 'Debug-SPM.xcconfig')
#      else
#        next
#      end
#      
#      if File.exist?(xcconfig_path)
#        config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
#      else
#        puts "Warning: xcconfig file not found at path: #{xcconfig_path}"
#      end
#    end
#  end
#end
#
## Helper method to remove SPM dependency
#def remove_spm_dependency(installer)
#  project_path = installer.pods_project.path
#  pbxproj_path = File.join(project_path, 'project.pbxproj')
#  
#  # Read the project file
#  project_content = File.read(pbxproj_path)
#  
#  # Remove references to the SPM package
#  if project_content.include?('DMErrorHandling')
#    project_content.gsub!(/\/\* DMErrorHandling \*\/.*?;[\r\n]+/, '')
#    project_content.gsub!(/\/\* DMErrorHandling.swiftmodule \*\/.*?;[\r\n]+/, '')
#    project_content.gsub!(/\/\* DMErrorHandling.framework \*\/.*?;[\r\n]+/, '')
#    
#    # Write the modified content back to the project file
#    File.write(pbxproj_path, project_content)
#    puts "Removed SPM dependency for DMErrorHandling."
#  else
#    puts "No SPM dependency found for DMErrorHandling."
#  end
#end
#
## Helper method to add SPM dependency
#def add_spm_dependency(installer)
#  # Open Xcode and manually add the SPM package via the GUI
#  puts "Please add the DMErrorHandling package via Xcode's 'Add Packages' menu."
#  puts "Path to DMErrorHandling: ../../"
#end

## Define the dependency manager based on the environment variable
#dependency_manager = ENV['DEPENDENCY_MANAGER'] || 'POD' # Default to POD if not specified
#
#target 'DMErrorHandlingPodExample' do
#  # Conditionally include the DMErrorHandling pod for CocoaPods
#  if dependency_manager == 'POD'
#    pod 'DMErrorHandling', path: '../../'
#    
#    # Remove the SPM package if it exists
#    post_install do |installer|
#      puts "Using CocoaPods as the dependency manager..."
#      
#      # Remove the SPM package reference
#      system("xcodebuild -removePackageDependency DMErrorHandling")
#      
#      # Apply xcconfig files
#      apply_xcconfig_files(installer)
#    end
#  else
#    # For SPM, ensure the pod is not included
#    puts "Using Swift Package Manager as the dependency manager..."
#    
#    # Add the SPM package if it doesn't exist
#    system("xcodebuild -addPackageDependency DMErrorHandling --path ../../")
#    
#    # Apply xcconfig files
#    post_install do |installer|
#      apply_xcconfig_files(installer)
#    end
#  end
#end
#
## Helper method to apply xcconfig files
#def apply_xcconfig_files(installer)
#  config_base_path = File.expand_path('DMErrorHandlingPodExample/Configuration', __dir__)
#  
#  installer.pods_project.targets.each do |target|
#    target.build_configurations.each do |config|
#      case config.name
#      when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
#        xcconfig_path = File.join(config_base_path, 'Debug-POD.xcconfig')
#      when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
#        xcconfig_path = File.join(config_base_path, 'Debug-SPM.xcconfig')
#      else
#        next
#      end
#      
#      if File.exist?(xcconfig_path)
#        config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
#      else
#        puts "Warning: xcconfig file not found at path: #{xcconfig_path}"
#      end
#    end
#  end
#end


# Default to POD if not specified

# Define a helper to check the dependency manager
def is_pod_configuration
  (ENV['DEPENDENCY_MANAGER'] || 'POD') == 'POD'
end

target 'DMErrorHandlingPodExample' do
  # Conditionally include the DMErrorHandling pod
  if is_pod_configuration
    use_frameworks!
    pod 'DMErrorHandling', path: '../../'
  end

#  post_install do |installer|
#    # Define the base path to the xcconfig files
#    config_base_path = File.expand_path('DMErrorHandlingPodExample/Configuration', __dir__)
#
#    installer.pods_project.targets.each do |target|
#      target.build_configurations.each do |config|
#        case config.name
#        when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
##          xcconfig_path = File.join(config_base_path, 'Debug-POD.xcconfig')
#xcconfig_path = ""
#        when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
#          xcconfig_path = File.join(config_base_path, 'Debug-SPM.xcconfig')
#        else
#          next # Skip if no matching configuration is found
#        end
#
#        # Ensure the xcconfig file exists before referencing it
#        if File.exist?(xcconfig_path)
#          config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
#        else
#          puts "Warning: xcconfig file not found at path: `#{xcconfig_path}`"
#        end
#      end
#    end
#  end
end


## Define a helper to check the current configuration
#def is_pod_configuration(config_name)
#  config_name.start_with?('Debug-POD') #|| config_name.start_with?('Release-POD')
#end
#
#target 'DMErrorHandlingPodExample' do
#  # Conditionally include the DMErrorHandling pod
#  if is_pod_configuration(ENV['CONFIGURATION'])
#    pod 'DMErrorHandling', path: '../../'
#    #  pod 'DMErrorHandling' , '~> 0.1.0'
#  end
#
#  # Post-install hook
#  post_install do |installer|
#    # Define the base path to the xcconfig files
#    config_base_path = File.expand_path('DMErrorHandlingPodExample/Configuration', __dir__)
#
#    # Iterate over all targets in the Pods project
#    installer.pods_project.targets.each do |target|
#      target.build_configurations.each do |config|
#        # Apply custom xcconfig for CocoaPods configurations
#        case config.name
#        when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
#          xcconfig_path = File.join(config_base_path, 'Debug-POD.xcconfig')
#        when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
#          xcconfig_path = File.join(config_base_path, 'Debug-SPM.xcconfig')
#        else
#          next # Skip if no matching configuration is found
#        end
#
#        # Ensure the xcconfig file exists before referencing it
#        if File.exist?(xcconfig_path)
#          config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
#        else
#          puts "Warning: xcconfig file not found at path: #{xcconfig_path}"
#        end
#      end
#    end
#  end
#  
#
#  post_install do |installer|
#    installer.pods_project.targets.each do |target|
#      target.build_configurations.each do |config|
#        case config.name
#        when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
#          xcconfig_path = File.join('Config', 'Debug-POD.xcconfig')
#        when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
#          xcconfig_path = File.join('Config', 'Debug-SPM.xcconfig')
#        else
#          next
#        end
#
#        if File.exist?(xcconfig_path)
#          config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
#        else
#          puts "Warning: xcconfig file not found at path: #{xcconfig_path}"
#        end
#      end
#    end
#  end
#end

#def shared_pods_for_testing
##  pod 'Quick', '~> 6.1.0'
##  pod 'Nimble', '~> 11.2.1'
#end
#
#project 'DMErrorHandlingPodExample.xcodeproj', 'Debug-POD-UIKitApp' => :debug, 'Debug-POD-SwiftUIApp' => :debug
#
#target 'DMErrorHandlingPodExample' do
#  use_frameworks!
#
#  pod 'DMErrorHandling', path: '../../'
##  pod 'DMErrorHandling' , '~> 0.1.0'
#
#  target 'DMErrorHandlingPodExampleTests' do
#    inherit! :search_paths
#    
#    shared_pods_for_testing
#  end
#
#  target 'DMErrorHandlingPodExampleUITests' do
#    shared_pods_for_testing
#  end
#end

#post_install do |installer|
#  installer.pods_project.targets.each do |target|
#    target.build_configurations.each do |config|
#      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
#    end
#  end
#end
