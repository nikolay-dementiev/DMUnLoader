
platform :ios, '17.0'

# Define a helper to read the DEPENDENCY_MANAGER from a file or environment variable
def dependency_manager
  # Read from the environment variable if provided
  return ENV['DEPENDENCY_MANAGER'] if ENV['DEPENDENCY_MANAGER']

  # Read from the .dependency_manager file if it exists
  if File.exist?('.dependency_manager')
    File.readlines('.dependency_manager').each do |line|
      if line.start_with?('DEPENDENCY_MANAGER=')
        return line.strip.split('=').last
      end
    end
  end

  # Default to 'POD' if no value is found
  'POD'
end

# Define a helper to check if the dependency manager is 'POD'
def is_pod_configuration
  dependency_manager == 'POD'
end

# Save the current dependency manager to a file (optional)
def save_dependency_manager(manager)
  File.write('.dependency_manager', "DEPENDENCY_MANAGER=#{manager}")
end

# Print the DEPENDENCY_MANAGER being used
current_dependency_manager = dependency_manager
puts ">>> Using DEPENDENCY_MANAGER: `#{current_dependency_manager}` <<< "

def clean_xcode_project
  puts "Cleaning Xcode project..."

  # List all schemes in the workspace
  schemes = `xcodebuild -workspace DMErrorHandlingPodExample.xcworkspace -list`.lines.grep(/Schemes:/).first.split(':').last.split

  # Clean each scheme
  schemes.each do |scheme|
    puts "Cleaning scheme: #{scheme}"
    system("xcodebuild clean -workspace DMErrorHandlingPodExample.xcworkspace -scheme #{scheme}")
  end

  puts "Removing DerivedData..."
  derived_data_path = File.expand_path('~/Library/Developer/Xcode/DerivedData')
  system("rm -rf #{derived_data_path}")

  puts "Cleanup complete!"
end

# Run cleanup before installing pods
clean_xcode_project

# Main target configuration
target 'DMErrorHandlingPodExample' do
  # Conditionally include the DMErrorHandling pod
  if is_pod_configuration
    use_frameworks!
    pod 'DMErrorHandling', path: '../../'
  end
end

# Save the dependency manager to a file (optional, if you want to persist it)
save_dependency_manager(current_dependency_manager)


## Define a helper to check the dependency manager
#def is_pod_configuration
#  (ENV['DEPENDENCY_MANAGER'] || 'POD') == 'POD'
#end
#
#target 'DMErrorHandlingPodExample' do
#  # Conditionally include the DMErrorHandling pod
#  if is_pod_configuration
#    use_frameworks!
#    pod 'DMErrorHandling', path: '../../'
#  end
#
##  post_install do |installer|
##    # Define the base path to the xcconfig files
##    config_base_path = File.expand_path('DMErrorHandlingPodExample/Configuration', __dir__)
##
##    installer.pods_project.targets.each do |target|
##      target.build_configurations.each do |config|
##        case config.name
##        when 'Debug-POD-UIKit', 'Debug-POD-SwiftUI'
###          xcconfig_path = File.join(config_base_path, 'Debug-POD.xcconfig')
##xcconfig_path = ""
##        when 'Debug-SPM-UIKit', 'Debug-SPM-SwiftUI'
##          xcconfig_path = File.join(config_base_path, 'Debug-SPM.xcconfig')
##        else
##          next # Skip if no matching configuration is found
##        end
##
##        # Ensure the xcconfig file exists before referencing it
##        if File.exist?(xcconfig_path)
##          config.base_configuration_reference = installer.pods_project.new_file(xcconfig_path)
##        else
##          puts "Warning: xcconfig file not found at path: `#{xcconfig_path}`"
##        end
##      end
##    end
##  end
#
#end


#def shared_pods_for_testing
##  pod 'Quick', '~> 6.1.0'
##  pod 'Nimble', '~> 11.2.1'
#end
#
#project 'DMErrorHandlingPodExample.xcodeproj', 'Debug-POD-UIKitApp' => :debug, 'Debug-POD-SwiftUIApp' => :debug
#
#target 'DMErrorHandlingPodExample' do
#  use_frameworks!
#
#  pod 'DMErrorHandling', path: '../../'
##  pod 'DMErrorHandling' , '~> 0.1.0'
#
#  target 'DMErrorHandlingPodExampleTests' do
#    inherit! :search_paths
#    
#    shared_pods_for_testing
#  end
#
#  target 'DMErrorHandlingPodExampleUITests' do
#    shared_pods_for_testing
#  end
#end

#post_install do |installer|
#  installer.pods_project.targets.each do |target|
#    target.build_configurations.each do |config|
#      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
#    end
#  end
#end
